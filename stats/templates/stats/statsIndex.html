{% extends 'base.html'%}
{% block content %}

<div class="text-center">
  Select Year:
  <select id="yearSelect">
    {% for year in years %}
    <option value="{{year}}">{{year}}</option>
    {% endfor %}
  </select>
</div>
<div id="barchart" style="width: 900px; height: 300px;"></div>

<div class="text-center">
  Select Month: <input type="month" id="yearAndMonthInput" class="form-input">
</div>
<div id="piechart" style="width: 900px; height: 500px;"></div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script type="text/javascript">
  $(document).ready(function () {
    var currentDate = new Date()
    var monthString;
    if (currentDate.getMonth() < 10) {
      monthString = "0" + String(currentDate.getMonth() + 1)
    }
    else monthString = String(currentDate.getMonth() + 1)
    $("#yearAndMonthInput").val(currentDate.getFullYear() + "-" + monthString)
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(getDataAndDrawChart);
  });

  $("#yearSelect").change(function (e) {
    e.preventDefault();
    console.log($("#yearSelect").val())
    $.ajax({
      url: 'monthAmountStat',
      action: 'get',
      data: { year: $("#yearSelect").val() },
      success: function (response) {
        chartDataArray = Object.entries(response)
        chartDataArray.unshift(['Month', 'Amount Spent'])
        console.log(chartDataArray)
        // drawBarChart(chartDataArray, 'barchart')
        drawColumnChart(chartDataArray, 'barchart')

      }
    })
  });

  function drawBarChart(chartDataArray, divID) {
    var data = google.visualization.arrayToDataTable(chartDataArray);
    var options = {
      title: "Amount Spent Per Month",
      width: 600,
      height: 400,
      bar: { groupWidth: "95%" },
      legend: { position: "none" },
    };
    var chart = new google.visualization.BarChart(document.getElementById(divID));
    chart.draw(data, options);
  }

  function drawColumnChart(chartDataArray, divID) {
    var data = google.visualization.arrayToDataTable(chartDataArray);
    var view = new google.visualization.DataView(data);
    view.setColumns([0, 1,
      {
        calc: "stringify",
        sourceColumn: 1,
        type: "string",
        role: "annotation"
      },
      2]);
    var options = {
      title: "Amount Spent Per Month",
      width: 600,
      height: 400,
      bar: { groupWidth: "95%" },
      legend: { position: "none" },
    };
    var chart = new google.visualization.ColumnChart(document.getElementById(divID));
    chart.draw(view, options);
  }

  $("#yearAndMonthInput").change(function (e) {
    e.preventDefault();
    console.log($("#yearAndMonthInput").val())
    getDataAndDrawChart()
  });
  function getDataAndDrawChart() {
    $.ajax({
      url: 'categoryAmountStat',
      action: 'get',
      data: { yearAndMonth: $("#yearAndMonthInput").val() },
      success: function (response) {
        chartDataArray = Object.entries(response)
        chartDataArray.unshift(['Category', 'Amount Spent'])
        console.log(chartDataArray)
        drawPieChart(chartDataArray, 'piechart')
      }
    })
  }
  function drawPieChart(chartDataArray, divID) {
    var data = google.visualization.arrayToDataTable(chartDataArray);
    var options = {
      title: 'Amount Spent in Different Categories'
    };
    var chart = new google.visualization.PieChart(document.getElementById(divID));
    chart.draw(data, options);
  }



</script>

{% endblock %}